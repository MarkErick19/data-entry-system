<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Data Entry System</title>
<style>
/* Reset & global */
* { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
html { font-size: clamp(12px, 1vw, 16px); }
body { background: #eef2f7; padding: 2vh 2vw; color: #333; }

/* Container */
.container { max-width: 1200px; margin: auto; background: #fff; padding: 2vh 2vw; border-radius: 1vw; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }

/* Headings */
h2, h3 { margin-bottom: 1vh; color: #222; }

/* Inputs, selects, buttons */
input, textarea, select, button { padding: 0.8vh 0.8vw; margin-bottom: 0.5vh; font-size: 1rem; width: 100%; border-radius: 0.4vw; border: 1px solid #ccc; transition: 0.3s; }
input:focus, textarea:focus, select:focus { border-color: #4CAF50; outline: none; box-shadow: 0 0 5px rgba(76, 175, 80, 0.5); }

/* Buttons */
button { cursor: pointer; font-weight: bold; transition: 0.3s; }
button:hover { opacity: 0.9; }

.save { background: #4CAF50; color: #fff; }
.cancel { background: #f39c12; color: #fff; }
.logout { background: #e74c3c; color: #fff; float: right; margin-bottom: 1vh; }
.export { background: #34495e; color: #fff; margin-left: 0.5vw; }
.delete-all { background: #c0392b; color: #fff; margin-left: 0.5vw; }
.view-btn { background: #2980b9; color: #fff; }
.edit-btn { background: #f39c12; color: #fff; }

/* Modal Buttons (professional & smaller) */
#modalContent button, #editModalContent button {
  padding: 0.5vh 1vw;
  font-size: 0.9rem;
  border-radius: 0.3vw;
  margin-left: 0.5vw;
  float: right;
  background-color: #2980b9;
  color: #fff;
  border: none;
  cursor: pointer;
  transition: 0.3s;
}
#modalContent button:hover, #editModalContent button:hover {
  background-color: #2471a3;
}

/* Form */
.form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1vw; margin-top: 1vh; }
.form-actions { grid-column: span 3; display: flex; justify-content: space-between; margin-top: 1vh; }
.form-actions button { width: 48%; }

/* Table */
.table-container { height: 50vh; overflow: auto; border: 1px solid #ccc; margin-top: 1vh; border-radius: 0.5vw; }
table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
th, td { border: 1px solid #ccc; padding: 0.5vh 0.5vw; text-align: center; transition: background 0.3s; }
th { background: #34495e; color: #fff; position: sticky; top: 0; z-index: 2; }
tbody tr:hover { background: #f1f7fc; cursor: pointer; }
.highlight { background: #fffa90 !important; }

/* Modal */
#modal, #editModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; }
#modalContent, #editModalContent { background: #fff; margin: 2% auto; padding: 2vh 2vw; border-radius: 1vw; max-width: 95%; box-shadow: 0 8px 30px rgba(0,0,0,0.2); }
#editModalContent { max-height: 80vh; overflow: auto; }

/* Print */
@media print {
  body * { visibility: hidden; }
  #modal, #modal * { visibility: visible; }
  #modal { position: absolute; inset: 0; background: #fff; }
  #modalContent button { display: none !important; }
  #printHeader { display: flex !important; justify-content: space-between; }
  @page { size: landscape; margin: 10mm; }
}

/* Print Header */
#printHeader { display: none; justify-content: space-between; margin-bottom: 1vh; }
#printHeader h2 { margin: 0; }

/* Signature */
.signature { margin-top: 4vh; display: flex; justify-content: space-between; gap: 2vw; }
.signature span { width: 30%; text-align: center; position: relative; padding-top: 1.5vh; }
.signature span::before { content: ""; position: absolute; top: 0.8vh; left: 0; right: 0; border-top: 1px solid #000; }
.signature .name { position: absolute; top: -0.2vh; left: 50%; transform: translateX(-50%); background: #fff; padding: 0 0.5vw; font-weight: bold; }

/* Login Box */
#loginBox { max-width: 400px; margin: 5vh auto; padding: 3vh 2vw; border-radius: 1vw; box-shadow: 0 8px 25px rgba(0,0,0,0.2); background: #fff; }
#loginBox h2 { text-align: center; margin-bottom: 2vh; }
#loginBox button { width: 100%; }

/* Buttons hover effects */
.save:hover { background: #45a049; }
.cancel:hover { background: #e67e22; }
.logout:hover { background: #c0392b; }
.export:hover { background: #2c3e50; }
.delete-all:hover { background: #a93226; }
.view-btn:hover { background: #2471a3; }
.edit-btn:hover { background: #e67e22; }

/* Responsive adjustments */
@media (max-width: 768px) {
  .form-actions { flex-direction: column; gap: 1vh; }
  .form-actions button { width: 100%; }
}
</style>
</head>
<body>

<!-- LOGIN -->
<div class="container" id="loginBox">
  <h2>Login</h2>
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <button class="save" onclick="login()">Login</button>
</div>

<!-- APP -->
<div class="container" id="app" style="display:none">
  <button class="logout" onclick="logout()">Logout</button>
  <h2>Data Entry</h2>

  <div style="display:flex;gap:1vw;flex-wrap:wrap;margin-bottom:1vh">
    <input type="file" accept=".csv" onchange="importCSV(this)">
    <button class="export" onclick="exportCSV()">Export CSV</button>
    <button class="delete-all" onclick="deleteAllRecords()">Delete All</button>
    <input id="searchBox" placeholder="Search Code" oninput="render()">
    <input id="searchMRI" placeholder="Search MRI" oninput="render()">
    <button onclick="clearSearch()">Clear Search</button>
  </div>

  <form id="form" class="form-grid">
    <input id="code" placeholder="Code" required autofocus>
    <input type="date" id="dateReq" required>
    <input id="part" placeholder="Part No." required>
    <textarea id="description" placeholder="Description"></textarea>
    <input type="number" id="qtyReq" placeholder="Qty Order" required>
    <input type="number" id="qtyRec" placeholder="Qty Allocated">
    <input id="backOrder" placeholder="Back Order" readonly>
    <input type="date" id="dateRec">
    <textarea id="remarks" placeholder="Remarks"></textarea>
    <input id="mri" placeholder="MRI No" required>
    <input id="dr" placeholder="DR No" required>
    <select id="receiver">
      <option value="">Select Receiver</option>
      <option value="G.SALUDO">G.SALUDO</option>
      <option value="J.C.P">J.C.P</option>
      <option value="M.DARADAR">M.DARADAR</option>
      <option value="J.SATIADA">J.SATIADA</option>
      <option value="G.MACA">G.MACA</option>
      <option value="A.LAZAGA">A.LAZAGA</option>
      <option value="M.STA. ANA">M.STA. ANA</option>
      <option value="C.PUERTOLLANO">C.PUERTOLLANO</option>
      <option value="D.ESTACION">D.ESTACION</option>
      <option value="JC.PASTORIN">JC.PASTORIN</option>
      <option value="J.RUEME">J.RUEME</option>
      <option value="R.ORGAYA">R.ORGAYA</option>
      <option value="R.SALAZAR">R.SALAZAR</option>
      <option value="B.CAROLINO">B.CAROLINO</option>
    </select>

    <div class="form-actions">
      <button class="save">Save</button>
      <button type="button" class="cancel" onclick="cancelEdit()">Cancel</button>
    </div>
  </form>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>#</th><th>Code</th><th>Date</th><th>Part</th><th>Description</th>
          <th>Order</th><th>Alloc</th><th>Back</th><th>Date Rec</th>
          <th>Remarks</th><th>MRI</th><th>DR</th><th>Receiver</th>
          <th>Action</th><th>View</th>
        </tr>
      </thead>
      <tbody id="table"></tbody>
      <tfoot id="summary"></tfoot>
    </table>
  </div>
</div>

<!-- VIEW MODAL -->
<div id="modal">
  <div id="modalContent">
    <div style="display:flex; justify-content:flex-end; gap:0.5vw; margin-bottom:1vh">
      <button onclick="printModal()">Print</button>
      <button onclick="closeModal()">Close</button>
    </div>
    <div id="printHeader">
      <h2>TOTAL MATERIAL HANDLING</h2>
      <div>Date: <span id="printDate"></span></div>
    </div>
    <div style="display:flex;justify-content:space-between;margin-bottom:1vh">
      <h3>MRI: <span id="modalMRI"></span></h3>
      <h3>DR: <span id="modalDR"></span></h3>
    </div>
    <table id="modalTable">
      <thead>
        <tr>
          <th>#</th><th>Code</th><th>Date</th><th>Part</th><th>Description</th>
          <th>Order</th><th>Alloc</th><th>Back</th><th>Date Rec</th>
          <th>Remarks</th><th>MRI</th><th>DR</th><th>Receiver</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="signature">
      <span>
        <div class="name"></div>
        Prepared By
      </span>
      <span>Received By</span>
      <span>Approved By</span>
    </div>
  </div>
</div>

<!-- EDIT MODAL -->
<div id="editModal">
  <div id="editModalContent">
    <div style="display:flex; justify-content:flex-end; gap:0.5vw; margin-bottom:1vh">
      <button onclick="closeEditModal()">Close</button>
    </div>
    <h3>Select record to edit</h3>
    <table id="editTable">
      <thead>
        <tr>
          <th>#</th><th>Code</th><th>Date</th><th>Part</th><th>Description</th>
          <th>Order</th><th>Alloc</th><th>Back</th><th>Date Rec</th>
          <th>Remarks</th><th>MRI</th><th>DR</th><th>Receiver</th><th>Select</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
// Google Sheets API
const API_URL = 'https://script.google.com/macros/s/AKfycbyjs9Ejpe1g6dfud_NT4lIpGoOGhyVJ6NU1si8ALN16hmKVPrIwChPCRyCj7vOgujdF/exec';

let records = [];
let editIndex = null;

// Login
function login(){
 if(username.value==='admin' && password.value==='1234'){
   loginBox.style.display='none';
   app.style.display='block';
   loadRecords();
 } else alert('Invalid credentials');
}
function logout(){location.reload();}

// Format dates
function formatDate(dateStr){
  if(!dateStr) return '';
  const d = new Date(dateStr);
  return d.toISOString().split('T')[0];
}

// Load records
async function loadRecords(){
 const res = await fetch(API_URL);
 records = await res.json();
 render();
}

// Form submit
form.onsubmit = async e=>{
 e.preventDefault();
 const r={
   code:code.value,dateReq:dateReq.value,part:part.value,
   description:description.value,qtyReq:+qtyReq.value,qtyRec:+qtyRec.value||0,
   backOrder:Math.max(+qtyReq.value-(+qtyRec.value||0),0),
   dateRec:dateRec.value,remarks:remarks.value,
   mri:mri.value,dr:dr.value,receiver:receiver.value
 };
 await fetch(API_URL,{method:'POST',body:JSON.stringify({action:'add',...r})});
 form.reset();receiver.selectedIndex=0;
 loadRecords();
};

qtyReq.oninput = qtyRec.oninput = ()=>backOrder.value=Math.max(+qtyReq.value-(+qtyRec.value||0),0);

// Render table
function render(){
 const c=searchBox.value.toLowerCase();
 const m=searchMRI.value.toLowerCase();
 const seen=new Set();
 let html='',tO=0,tA=0,tB=0;

 records.forEach((r,i)=>{
   if((c && !r.code.toLowerCase().includes(c)) || (m && !r.mri.toLowerCase().includes(m))) return;
   if(seen.has(r.mri)) return;
   seen.add(r.mri);
   tO+=+r.qtyReq; tA+=+r.qtyRec; tB+=+r.backOrder;

   html+=`<tr>
     <td>${seen.size}</td>
     <td>${r.code}</td>
     <td>${formatDate(r.dateReq)}</td>
     <td>${r.part}</td>
     <td>${r.description}</td>
     <td>${r.qtyReq}</td>
     <td>${r.qtyRec}</td>
     <td>${r.backOrder}</td>
     <td>${formatDate(r.dateRec)}</td>
     <td>${r.remarks}</td>
     <td>${r.mri}</td>
     <td>${r.dr}</td>
     <td>${r.receiver}</td>
     <td>
       <button class="edit-btn" onclick="openEditGroup('${r.mri}')">Edit</button>
       <button class="delete-all" onclick="deleteByMRI('${r.mri}')">Delete</button>
     </td>
     <td><button class="view-btn" onclick="openModal('${r.mri}')">View</button></td>
   </tr>`;
 });
 table.innerHTML = html;
 summary.innerHTML = `<tr><td colspan="5">TOTAL</td><td>${tO}</td><td>${tA}</td><td>${tB}</td><td colspan="7"></td></tr>`;
}

// View modal
function openModal(mri){
 modal.style.display='block';
 modalMRI.textContent = mri;
 printDate.textContent = new Date().toLocaleDateString();

 const body = document.querySelector('#modalTable tbody');
 body.innerHTML='';
 const list = records.filter(r => r.mri === mri);
 modalDR.textContent = list[0]?.dr || '';

 list.forEach((r,i)=>{
   body.innerHTML+=`<tr>
     <td>${i+1}</td>
     <td>${r.code}</td>
     <td>${formatDate(r.dateReq)}</td>
     <td>${r.part}</td>
     <td>${r.description}</td>
     <td>${r.qtyReq}</td>
     <td>${r.qtyRec}</td>
     <td>${r.backOrder}</td>
     <td>${formatDate(r.dateRec)}</td>
     <td>${r.remarks}</td>
     <td>${r.mri}</td>
     <td>${r.dr}</td>
     <td>${r.receiver}</td>
   </tr>`;
 });
}

function closeModal(){modal.style.display='none';}
function printModal(){
 const printHeader = document.getElementById('printHeader');
 printHeader.style.display='flex';
 window.print();
 printHeader.style.display='none';
}

// Edit modal
function openEditGroup(mri){
 const list = records.map((r,i)=>({...r,idx:i})).filter(r=>r.mri===mri);
 if(list.length===1){
   const r=list[0];
   ['code','dateReq','part','description','qtyReq','qtyRec','backOrder','dateRec','remarks','mri','dr','receiver'].forEach(id=>document.getElementById(id).value=r[id]);
   editIndex=r.idx;
   code.focus();
   render();
 } else if(list.length>1){
   editModal.style.display='block';
   const body=document.querySelector('#editTable tbody');
   body.innerHTML='';
   list.forEach((r,i)=>{
     body.innerHTML+=`<tr>
       <td>${i+1}</td>
       <td>${r.code}</td>
       <td>${formatDate(r.dateReq)}</td>
       <td>${r.part}</td>
       <td>${r.description}</td>
       <td>${r.qtyReq}</td>
       <td>${r.qtyRec}</td>
       <td>${r.backOrder}</td>
       <td>${formatDate(r.dateRec)}</td>
       <td>${r.remarks}</td>
       <td>${r.mri}</td>
       <td>${r.dr}</td>
       <td>${r.receiver}</td>
       <td><button onclick="selectRecord(${r.idx})">Select</button></td>
     </tr>`;
   });
 }
}

function closeEditModal(){editModal.style.display='none';}
function selectRecord(index){
 const r = records[index];
 ['code','dateReq','part','description','qtyReq','qtyRec','backOrder','dateRec','remarks','mri','dr','receiver'].forEach(id=>document.getElementById(id).value=r[id]);
 editIndex=index; closeEditModal(); code.focus(); render();
}

// Delete
function deleteAllRecords(){if(confirm('Delete ALL records?')){records=[]; render();}}
function deleteByMRI(mri){
 if(!confirm(`Delete ALL records under MRI: ${mri}?`)) return;
 const pass=prompt('Enter ADMIN password:');
 if(pass!=='1234'){alert('Invalid password');return;}
 records = records.filter(r=>r.mri!==mri); render();
}

// CSV
function exportCSV(){
 let csv='Code,Date,Part,Description,QtyOrder,QtyAlloc,Back,DateRec,Remarks,MRI,DR,Receiver\n';
 records.forEach(r=>csv+=`${r.code},${formatDate(r.dateReq)},${r.part},"${r.description}",${r.qtyReq},${r.qtyRec},${r.backOrder},${formatDate(r.dateRec)},"${r.remarks}",${r.mri},${r.dr},${r.receiver}\n`);
 const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv])); a.download='records.csv'; a.click();
}

function importCSV(input){
 const f=input.files[0]; if(!f)return;
 const reader=new FileReader();
 reader.onload=e=>{
   const lines=e.target.result.split(/\r?\n/);
   lines.slice(1).forEach(l=>{
     if(!l.trim()) return;
     const regex= /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;
     const v=l.split(regex).map(x=>x.replace(/^"|"$/g,'').trim());
     if(v.length>=12) records.push({code:v[0],dateReq:v[1],part:v[2],description:v[3],qtyReq:+v[4],qtyRec:+v[5],backOrder:Math.max(v[4]-v[5],0),dateRec:v[7],remarks:v[8],mri:v[9],dr:v[10],receiver:v[11]});
   });
   render();
 };
 reader.readAsText(f); input.value='';
}

function clearSearch(){searchBox.value='';searchMRI.value=''; render();}
</script>
</body>
</html>
