<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Data Entry System</title>

<style>
*{box-sizing:border-box;font-family:Arial,sans-serif;margin:0;padding:0}
body{background:#eef2f7;padding:20px}
.container{max-width:1200px;margin:auto;background:#fff;padding:20px;border-radius:8px}
h2{text-align:center;margin-bottom:20px}
input,select,textarea,button{padding:6px;font-size:14px}
button{cursor:pointer}

.login-box{max-width:300px;margin:100px auto}
.login-box input{width:100%;margin-bottom:10px}

.form-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.form-grid textarea{grid-column:span 4}

.actions{margin-top:10px}
.actions button{margin-right:5px}

table{width:100%;border-collapse:collapse;margin-top:20px;font-size:13px}
th,td{border:1px solid #ccc;padding:5px;text-align:center}
th{background:#f0f0f0}

.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5)}
.modal-content{background:#fff;padding:20px;margin:50px auto;width:90%;max-width:900px}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="login-box" id="loginBox">
  <h2>Login</h2>
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <button type="button" onclick="login()">Login</button>
</div>

<!-- APP -->
<div class="container" id="app" style="display:none">
<h2>Data Entry System</h2>

<form id="form">
<div class="form-grid">
  <input id="code" placeholder="Code">
  <input id="dateReq" type="date">
  <input id="part" placeholder="Part">
  <input id="description" placeholder="Description">
  <input id="qtyReq" type="number" placeholder="Qty Order">
  <input id="qtyRec" type="number" placeholder="Qty Alloc">
  <input id="backOrder" type="number" placeholder="Back Order">
  <input id="dateRec" type="date">
  <input id="remarks" placeholder="Remarks">
  <input id="mri" placeholder="MRI">
  <input id="dr" placeholder="DR">
  <input id="receiver" placeholder="Receiver">
</div>

<div class="actions">
  <button type="submit">Save</button>
  <button type="button" onclick="cancelEdit()">Cancel</button>
</div>
</form>

<table>
<thead>
<tr>
<th>Code</th><th>Date</th><th>Part</th><th>Description</th>
<th>Qty Order</th><th>Qty Alloc</th><th>Back Order</th>
<th>Date Rec</th><th>Remarks</th><th>MRI</th>
<th>DR</th><th>Receiver</th><th>Action</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<!-- VIEW MODAL -->
<div class="modal" id="viewModal">
<div class="modal-content">
  <button onclick="closeModal()">Close</button>
  <button onclick="printModal()">Print</button>
  <pre id="modalData"></pre>
</div>
</div>

<script>
/* ========= CONFIG ========= */
const API_URL = "https://script.google.com/macros/s/AKfycbzLwiSBka1awD6Aw6rHbXM5PxAjOUd3zHk3jiR8tjJNz2kTpuZ8pwm3v1k2xzTzKssN/exec";

/* ========= GLOBALS ========= */
let records = [];
let editIndex = null;

/* ========= LOGIN ========= */
function login(){
  if(username.value==='admin' && password.value==='1234'){
    loginBox.style.display='none';
    app.style.display='block';
    loadRecords();
  } else alert('Invalid login');
}

/* ========= LOAD ========= */
async function loadRecords(){
  const res = await fetch(API_URL);
  records = await res.json();
  render();
}

/* ========= RENDER ========= */
function render(){
  tbody.innerHTML='';
  records.forEach((r,i)=>{
    tbody.innerHTML+=`
    <tr>
      <td>${r.code}</td><td>${r.dateReq}</td><td>${r.part}</td>
      <td>${r.description}</td><td>${r.qtyReq}</td><td>${r.qtyRec}</td>
      <td>${r.backOrder}</td><td>${r.dateRec}</td><td>${r.remarks}</td>
      <td>${r.mri}</td><td>${r.dr}</td><td>${r.receiver}</td>
      <td>
        <button onclick="view(${i})">View</button>
        <button onclick="edit(${i})">Edit</button>
        <button onclick="del('${r.mri}')">Delete</button>
      </td>
    </tr>`;
  });
}

/* ========= SAVE ========= */
form.onsubmit = async e=>{
  e.preventDefault();

  const data = {
    action: editIndex===null?'add':'update',
    index: editIndex,
    code:code.value,dateReq:dateReq.value,part:part.value,
    description:description.value,qtyReq:+qtyReq.value,
    qtyRec:+qtyRec.value,backOrder:+backOrder.value,
    dateRec:dateRec.value,remarks:remarks.value,
    mri:mri.value,dr:dr.value,receiver:receiver.value
  };

  await fetch(API_URL,{method:'POST',body:JSON.stringify(data)});
  cancelEdit();
  loadRecords();
};

/* ========= EDIT ========= */
function edit(i){
  editIndex=i;
  Object.keys(records[i]).forEach(k=>{
    if(document.getElementById(k)) document.getElementById(k).value=records[i][k];
  });
}

/* ========= CANCEL ========= */
function cancelEdit(){
  editIndex=null;
  form.reset();
}

/* ========= VIEW ========= */
function view(i){
  modalData.textContent=JSON.stringify(records[i],null,2);
  viewModal.style.display='block';
}
function closeModal(){viewModal.style.display='none'}
function printModal(){window.print()}

/* ========= DELETE ========= */
async function del(mri){
  if(!confirm('Delete all records with MRI '+mri+'?'))return;
  await fetch(API_URL,{
    method:'POST',
    body:JSON.stringify({action:'deleteByMRI',mri})
  });
  loadRecords();
}
</script>

</body>
</html>
